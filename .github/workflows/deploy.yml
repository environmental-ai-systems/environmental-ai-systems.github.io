name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout public repo
      uses: actions/checkout@v4
      with:
        ref: main
      
    - name: Checkout private people data
      uses: actions/checkout@v4
      with:
        repository: environmental-ai-systems/environmental-ai-systems-private
        token: ${{ secrets.PRIVATE_REPO_TOKEN }}
        path: private-data
    
    - name: Copy people data
      run: |
        mkdir -p _data
        cp private-data/people.yml _data/people.yml
        if [ -f private-data/events.yml ]; then
          cp private-data/events.yml _data/events.yml
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install pyyaml
    
    - name: Generate people.html from YAML
      run: |
        python generate_people_page.py
        
    - name: Generate events section from YAML
      run: |
        if [ -f _data/events.yml ]; then
          python generate_events_section.py
          # Inject events into index.html
          if [ -f events_section.html ]; then
            sed -i '/<div id="events-container">/,/<\/div>/c\<div id="events-container">\n'"$(cat events_section.html)"'\n</div>' index.html
          fi
        fi
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
